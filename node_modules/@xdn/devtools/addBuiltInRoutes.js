const path = require('path')

const FAR_FUTURE_TTL = 60 * 60 * 24 * 365 * 10

const PUBLIC_CACHE_CONFIG = {
  edge: {
    maxAgeSeconds: FAR_FUTURE_TTL,
  },
  browser: false,
}

const XDN_DEVTOOLS_ENABLED_COOKIE = 'xdn-devtools-enabled'
const XDN_DEVTOOLS_ENV_ENABLED_COOKIE = 'xdn-devtools-env-enabled'

function isDevtoolEnabledByDefault() {
  if (process.env.XDN_DEVTOOLS_ENABLED) {
    return process.env.XDN_DEVTOOLS_ENABLED === 'true'
  }
  // XDN_DEVTOOLS_ENABLED cannot be set manually on Environment config
  // because XDN_* is reserved for internal usage, which we will use when adding
  // that feature explictely to LD interface.
  // Meanwhile, the PREVIEW_XDN_DEVTOOLS_ENABLED can be set manually by anyone
  if (process.env.PREVIEW_XDN_DEVTOOLS_ENABLED) {
    return process.env.PREVIEW_XDN_DEVTOOLS_ENABLED === 'true'
  }

  // If neither of those are defined, we fallback on default behavior:
  // it will be enabled on local and moovweb-edge(-dev).io domains
  return null
}

module.exports = function addBuiltInRoutes(router) {
  if (isDevtoolEnabledByDefault() !== null) {
    router.match('/(.*)', ({ addResponseCookie }) => {
      addResponseCookie(XDN_DEVTOOLS_ENV_ENABLED_COOKIE, `${isDevtoolEnabledByDefault()}; Path=/`)
    })
  }
  router
    .get('/__xdn__/devtools/enable', ({ redirect, addResponseCookie }) => {
      addResponseCookie(XDN_DEVTOOLS_ENABLED_COOKIE, 'true; Path=/')
      redirect('/')
    })
    .get('/__xdn__/devtools/disable', ({ redirect, addResponseCookie }) => {
      addResponseCookie(XDN_DEVTOOLS_ENABLED_COOKIE, 'false; Path=/')
      redirect('/')
    })
    .match('/__xdn__/devtools/:path*', ({ cache, serveStatic }) => {
      cache(PUBLIC_CACHE_CONFIG)
      serveStatic(path.join('node_modules', '@xdn', 'devtools', 'widget', ':path*'))
    })
}
